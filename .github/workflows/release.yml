name: å‘ç‰ˆ

on:
  workflow_dispatch:
    inputs:
      target_version:
        description: "ç›®æ ‡ç‰ˆæœ¬å· (ä¾‹å¦‚: 1.0.0, 1.0.0-beta.0, 1.0.0-rc.0)"
        required: true
        type: string
      dry_run:
        description: "é¢„æ¼”æ¨¡å¼"
        required: true
        default: true
        type: boolean

permissions:
  id-token: write
  contents: read

jobs:
  npm-release:
    name: NPM å‘å¸ƒ
    runs-on: ubuntu-latest
    concurrency:
      group: npm-release-${{ github.ref }}
      cancel-in-progress: false
    permissions:
      contents: write
      issues: write
      pull-requests: write
      id-token: write
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: éªŒè¯
        run: |
          echo "å½“å‰åˆ†æ”¯: ${{ github.ref_name }}"
          echo "ç›®æ ‡ç‰ˆæœ¬: ${{ github.event.inputs.target_version }}"
          echo "é¢„æ¼”æ¨¡å¼: ${{ github.event.inputs.dry_run }}"

          # éªŒè¯ç‰ˆæœ¬å·æ ¼å¼
          TARGET_VERSION="${{ github.event.inputs.target_version }}"
          if [[ ! "$TARGET_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-(beta|rc)\.[0-9]+)?$ ]]; then
            echo "âŒ ç‰ˆæœ¬å·æ ¼å¼æ— æ•ˆï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹æ ¼å¼ä¹‹ä¸€ï¼š"
            echo "   - æ­£å¼ç‰ˆ: 1.0.0"
            echo "   - Betaç‰ˆ: 1.0.0-beta.0"
            echo "   - RCç‰ˆ: 1.0.0-rc.0"
            exit 1
          fi

          # æ£€æŸ¥åˆ†æ”¯æƒé™ï¼ˆå…è®¸åœ¨featureåˆ†æ”¯è¿›è¡Œæµ‹è¯•å‘å¸ƒï¼‰
          if [[ "$TARGET_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]] && [ "${{ github.event.inputs.dry_run }}" != "true" ]; then
            if [ "${{ github.ref_name }}" != "main" ]; then
              echo "âŒ æ­£å¼ç‰ˆå‘å¸ƒå¿…é¡»åœ¨ä¸»åˆ†æ”¯è¿›è¡Œ"
              exit 1
            fi
          fi

      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.13.1

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"
          cache: "pnpm"
          registry-url: "https://registry.npmjs.org"

      - name: å®‰è£…ä¾èµ–
        run: |
          npm install -g npm@latest
          pnpm install --frozen-lockfile

      - name: é…ç½® Git ç”¨æˆ·
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: é€‰æ‹©å‘ç‰ˆé…ç½®
        id: select-config
        run: |
          TARGET_VERSION="${{ github.event.inputs.target_version }}"

          if [[ "$TARGET_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            # æ­£å¼ç‰ˆä½¿ç”¨å®Œæ•´é…ç½®
            CONFIG_FILE="config/.release-it.json"
            echo "âœ… æ£€æµ‹åˆ°æ­£å¼ç‰ˆç‰ˆæœ¬å·: $TARGET_VERSION"
            echo "ğŸ“‹ å°†æ‰§è¡Œå®Œæ•´å‘å¸ƒæµç¨‹ï¼šchangelog â†’ Git tag â†’ GitHub Release â†’ NPM"
          else
            # Beta/RC ç‰ˆä½¿ç”¨ç®€åŒ–é…ç½®
            CONFIG_FILE="config/.release-it-beta.json"
            echo "âœ… æ£€æµ‹åˆ°é¢„å‘å¸ƒç‰ˆæœ¬å·: $TARGET_VERSION"
            echo "ğŸ“‹ å°†æ‰§è¡Œç®€åŒ–å‘å¸ƒæµç¨‹ï¼šNPM only (è·³è¿‡ changelogã€tagã€GitHub Release)"
          fi

          echo "config_file=$CONFIG_FILE" >> $GITHUB_OUTPUT

      - name: å‘å¸ƒ
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          TARGET_VERSION="${{ github.event.inputs.target_version }}"
          CONFIG_FILE="${{ steps.select-config.outputs.config_file }}"

          # æ„å»ºå‘å¸ƒå‘½ä»¤
          RELEASE_CMD="npx release-it --ci --config $CONFIG_FILE $TARGET_VERSION"

          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            RELEASE_CMD="$RELEASE_CMD --dry-run"
            echo "ğŸ§ª é¢„æ¼”æ¨¡å¼ï¼šä¸ä¼šå®é™…æ‰§è¡Œå‘å¸ƒæ“ä½œ"
          fi

          echo ""
          echo "ğŸ“‹ å‘å¸ƒä¿¡æ¯ï¼š"
          echo "   - ç›®æ ‡ç‰ˆæœ¬: $TARGET_VERSION"
          echo "   - é…ç½®æ–‡ä»¶: $CONFIG_FILE"
          echo "   - å½“å‰åˆ†æ”¯: ${{ github.ref_name }}"
          echo "   - é¢„æ¼”æ¨¡å¼: ${{ github.event.inputs.dry_run }}"
          echo ""

          # æ‰§è¡Œå‘å¸ƒå‘½ä»¤
          echo "ğŸš€ æ‰§è¡Œå‘å¸ƒå‘½ä»¤..."
          eval "$RELEASE_CMD"
