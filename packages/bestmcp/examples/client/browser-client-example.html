<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BestMCP HTTP 客户端示例</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            background: white;
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        h1, h2, h3 {
            color: #333;
        }

        .status {
            padding: 8px 16px;
            border-radius: 4px;
            font-weight: bold;
            display: inline-block;
            margin-bottom: 16px;
        }

        .status.connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            margin-bottom: 4px;
            font-weight: bold;
            color: #555;
        }

        input, select, textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }

        textarea {
            height: 100px;
            font-family: 'Monaco', 'Menlo', monospace;
            resize: vertical;
        }

        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 8px;
            margin-bottom: 8px;
        }

        button:hover {
            background-color: #0056b3;
        }

        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        .tool-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .tool-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 16px;
            background-color: #f9f9f9;
        }

        .tool-card h4 {
            margin: 0 0 8px 0;
            color: #007bff;
        }

        .tool-card p {
            margin: 0 0 12px 0;
            color: #666;
            font-size: 14px;
        }

        .result {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 16px;
            margin-top: 16px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            overflow-x: auto;
        }

        .error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        .success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .config-section {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border: none;
            background: none;
            border-bottom: 2px solid transparent;
        }

        .tab.active {
            border-bottom-color: #007bff;
            color: #007bff;
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
        }

        .quick-action-btn {
            background-color: #28a745;
            font-size: 12px;
            padding: 6px 12px;
        }

        .quick-action-btn:hover {
            background-color: #218838;
        }

        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .metric-card {
            background-color: #e9ecef;
            padding: 16px;
            border-radius: 4px;
            text-align: center;
        }

        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }

        .metric-label {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🚀 BestMCP HTTP 客户端示例</h1>

        <div id="status" class="status disconnected">
            未连接
        </div>

        <div class="config-section">
            <h3>服务器配置</h3>
            <div class="form-group">
                <label for="serverUrl">服务器地址:</label>
                <input type="text" id="serverUrl" value="http://127.0.0.1:3000" placeholder="http://127.0.0.1:3000">
            </div>
            <button onclick="connectServer()">连接服务器</button>
            <button onclick="disconnectServer()">断开连接</button>
        </div>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="switchTab('tools')">工具列表</button>
        <button class="tab" onclick="switchTab('test')">工具测试</button>
        <button class="tab" onclick="switchTab('batch')">批量操作</button>
        <button class="tab" onclick="switchTab('monitor')">系统监控</button>
    </div>

    <!-- 工具列表标签页 -->
    <div id="tools-tab" class="tab-content active">
        <div class="container">
            <h2>📋 可用工具</h2>
            <button onclick="loadTools()">刷新工具列表</button>
            <div id="toolsList" class="tool-list">
                <p>点击"刷新工具列表"获取可用工具</p>
            </div>
        </div>
    </div>

    <!-- 工具测试标签页 -->
    <div id="test-tab" class="tab-content">
        <div class="container">
            <h2>🧪 工具测试</h2>

            <div class="form-group">
                <label for="toolSelect">选择工具:</label>
                <select id="toolSelect">
                    <option value="">请先连接服务器并加载工具列表</option>
                </select>
            </div>

            <div class="form-group">
                <label for="toolArgs">工具参数 (JSON):</label>
                <textarea id="toolArgs" placeholder='{"a": 5, "b": 3}'></textarea>
            </div>

            <button onclick="callTool()">调用工具</button>
            <button onclick="clearResult()" class="quick-action-btn">清空结果</button>

            <div class="quick-actions">
                <button class="quick-action-btn" onclick="quickCall('add', {'a': 15, 'b': 27})">add(15, 27)</button>
                <button class="quick-action-btn" onclick="quickCall('multiply', {'a': 8, 'b': 6})">multiply(8, 6)</button>
                <button class="quick-action-btn" onclick="quickCall('sqrt', {'num': 144})">sqrt(144)</button>
                <button class="quick-action-btn" onclick="quickCall('getServerStatus', {})">服务器状态</button>
                <button class="quick-action-btn" onclick="quickCall('healthCheck', {})">健康检查</button>
            </div>

            <div id="toolResult" class="result" style="display: none;"></div>
        </div>
    </div>

    <!-- 批量操作标签页 -->
    <div id="batch-tab" class="tab-content">
        <div class="container">
            <h2>🔄 批量操作</h2>

            <div class="form-group">
                <label for="batchTool">批量工具:</label>
                <select id="batchTool">
                    <option value="add">add - 加法运算</option>
                    <option value="multiply">multiply - 乘法运算</option>
                </select>
            </div>

            <div class="form-group">
                <label for="batchCount">执行次数:</label>
                <input type="number" id="batchCount" value="10" min="1" max="100">
            </div>

            <div class="form-group">
                <label for="batchConcurrency">并发数:</label>
                <input type="number" id="batchConcurrency" value="5" min="1" max="20">
            </div>

            <button onclick="runBatchTest()">运行批量测试</button>
            <button onclick="clearBatchResult()">清空结果</button>

            <div id="batchResult" class="result" style="display: none;"></div>
        </div>
    </div>

    <!-- 系统监控标签页 -->
    <div id="monitor-tab" class="tab-content">
        <div class="container">
            <h2>📊 系统监控</h2>

            <button onclick="startMonitoring()">开始监控</button>
            <button onclick="stopMonitoring()">停止监控</button>
            <button onclick="refreshMetrics()">刷新数据</button>

            <div id="metricsContainer" class="metrics">
                <!-- 指标将在这里显示 -->
            </div>

            <div id="monitorResult" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        // MCP HTTP 客户端类
        class MCPHttpClient {
            constructor(baseUrl) {
                this.baseUrl = baseUrl.replace(/\/$/, '');
                this.requestId = 1;
            }

            async callTool(toolName, arguments = {}) {
                const payload = {
                    jsonrpc: '2.0',
                    id: this.requestId++,
                    method: 'tools/call',
                    params: {
                        name: toolName,
                        arguments
                    }
                };

                const response = await fetch(`${this.baseUrl}/mcp`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP 错误: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();

                if (data.error) {
                    throw new Error(`工具调用失败: ${data.error.message}`);
                }

                return data.result;
            }

            async listTools() {
                const payload = {
                    jsonrpc: '2.0',
                    id: this.requestId++,
                    method: 'tools/list'
                };

                const response = await fetch(`${this.baseUrl}/mcp`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP 错误: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();

                if (data.error) {
                    throw new Error(`获取工具列表失败: ${data.error.message}`);
                }

                return data.result.tools;
            }

            async testConnection() {
                try {
                    await this.listTools();
                    return true;
                } catch (error) {
                    return false;
                }
            }
        }

        // 全局变量
        let client = null;
        let tools = [];
        let monitoringInterval = null;

        // 连接服务器
        async function connectServer() {
            const serverUrl = document.getElementById('serverUrl').value;
            const statusEl = document.getElementById('status');

            statusEl.innerHTML = '<div class="loading"></div>连接中...';
            statusEl.className = 'status disconnected';

            try {
                client = new MCPHttpClient(serverUrl);
                const isConnected = await client.testConnection();

                if (isConnected) {
                    statusEl.textContent = '✅ 已连接';
                    statusEl.className = 'status connected';
                    await loadTools();
                    showResult('toolResult', '服务器连接成功！', 'success');
                } else {
                    statusEl.textContent = '❌ 连接失败';
                    statusEl.className = 'status disconnected';
                    showResult('toolResult', '无法连接到服务器，请检查地址是否正确', 'error');
                }
            } catch (error) {
                statusEl.textContent = '❌ 连接失败';
                statusEl.className = 'status disconnected';
                showResult('toolResult', `连接错误: ${error.message}`, 'error');
            }
        }

        // 断开服务器连接
        function disconnectServer() {
            client = null;
            tools = [];

            const statusEl = document.getElementById('status');
            statusEl.textContent = '未连接';
            statusEl.className = 'status disconnected';

            document.getElementById('toolsList').innerHTML = '<p>点击"刷新工具列表"获取可用工具</p>';
            document.getElementById('toolSelect').innerHTML = '<option value="">请先连接服务器并加载工具列表</option>';

            stopMonitoring();
            showResult('toolResult', '已断开连接', 'success');
        }

        // 加载工具列表
        async function loadTools() {
            if (!client) {
                showResult('toolResult', '请先连接服务器', 'error');
                return;
            }

            try {
                tools = await client.listTools();
                displayTools();
                updateToolSelect();
                showResult('toolResult', `成功加载 ${tools.length} 个工具`, 'success');
            } catch (error) {
                showResult('toolResult', `加载工具列表失败: ${error.message}`, 'error');
            }
        }

        // 显示工具列表
        function displayTools() {
            const container = document.getElementById('toolsList');

            if (tools.length === 0) {
                container.innerHTML = '<p>没有可用工具</p>';
                return;
            }

            container.innerHTML = tools.map(tool => `
                <div class="tool-card">
                    <h4>${tool.name}</h4>
                    <p>${tool.description}</p>
                    <button class="quick-action-btn" onclick="quickCall('${tool.name}', ${JSON.stringify(getDefaultArgs(tool.inputSchema))})">
                        快速调用
                    </button>
                </div>
            `).join('');
        }

        // 获取工具的默认参数
        function getDefaultArgs(inputSchema) {
            const args = {};
            if (inputSchema && inputSchema.properties) {
                Object.entries(inputSchema.properties).forEach(([key, schema]) => {
                    if (schema.default !== undefined) {
                        args[key] = schema.default;
                    } else if (schema.type === 'number') {
                        args[key] = 0;
                    } else if (schema.type === 'string') {
                        args[key] = '';
                    } else if (schema.type === 'boolean') {
                        args[key] = false;
                    }
                });
            }
            return args;
        }

        // 更新工具选择下拉框
        function updateToolSelect() {
            const select = document.getElementById('toolSelect');
            select.innerHTML = '<option value="">选择一个工具</option>' +
                tools.map(tool => `<option value="${tool.name}">${tool.name} - ${tool.description}</option>`).join('');
        }

        // 调用工具
        async function callTool() {
            if (!client) {
                showResult('toolResult', '请先连接服务器', 'error');
                return;
            }

            const toolName = document.getElementById('toolSelect').value;
            const argsText = document.getElementById('toolArgs').value;

            if (!toolName) {
                showResult('toolResult', '请选择一个工具', 'error');
                return;
            }

            try {
                let args = {};
                if (argsText.trim()) {
                    args = JSON.parse(argsText);
                }

                showResult('toolResult', '正在调用工具...', '');

                const result = await client.callTool(toolName, args);
                showResult('toolResult', `工具 "${toolName}" 执行成功:\n\n${JSON.stringify(result, null, 2)}`, 'success');

            } catch (error) {
                showResult('toolResult', `工具调用失败: ${error.message}`, 'error');
            }
        }

        // 快速调用工具
        async function quickCall(toolName, args) {
            if (!client) {
                showResult('toolResult', '请先连接服务器', 'error');
                return;
            }

            try {
                showResult('toolResult', `正在调用 ${toolName}...`, '');
                const result = await client.callTool(toolName, args);
                showResult('toolResult', `工具 "${toolName}" 执行成功:\n\n${JSON.stringify(result, null, 2)}`, 'success');
            } catch (error) {
                showResult('toolResult', `快速调用失败: ${error.message}`, 'error');
            }
        }

        // 批量测试
        async function runBatchTest() {
            if (!client) {
                showResult('batchResult', '请先连接服务器', 'error');
                return;
            }

            const toolName = document.getElementById('batchTool').value;
            const count = parseInt(document.getElementById('batchCount').value);
            const concurrency = parseInt(document.getElementById('batchConcurrency').value);

            showResult('batchResult', `开始批量测试: ${count} 次 ${toolName} 调用，并发数 ${concurrency}`, '');

            const startTime = Date.now();
            const results = [];
            let errors = 0;

            // 分批执行
            for (let i = 0; i < count; i += concurrency) {
                const batch = [];
                const batchSize = Math.min(concurrency, count - i);

                for (let j = 0; j < batchSize; j++) {
                    let args = {};
                    if (toolName === 'add') {
                        args = { a: i + j, b: (i + j) * 2 };
                    } else if (toolName === 'multiply') {
                        args = { a: i + j, b: 3 };
                    }

                    batch.push(
                        client.callTool(toolName, args)
                            .then(result => ({ success: true, result }))
                            .catch(error => ({ success: false, error: error.message }))
                    );
                }

                const batchResults = await Promise.all(batch);
                results.push(...batchResults);
                errors += batchResults.filter(r => !r.success).length;

                // 更新进度
                const progress = Math.min((i + batchSize), count);
                showResult('batchResult',
                    `进度: ${progress}/${count} (${Math.round(progress/count*100)}%)\n` +
                    `成功: ${results.length - errors}, 失败: ${errors}`,
                    ''
                );
            }

            const endTime = Date.now();
            const duration = endTime - startTime;

            const summary = {
                toolName,
                totalRequests: count,
                successCount: results.length - errors,
                errorCount: errors,
                duration,
                avgTime: duration / count,
                throughput: (results.length - errors) / (duration / 1000)
            };

            showResult('batchResult',
                `批量测试完成!\n\n` +
                `工具: ${summary.toolName}\n` +
                `总请求数: ${summary.totalRequests}\n` +
                `成功数: ${summary.successCount}\n` +
                `失败数: ${summary.errorCount}\n` +
                `总耗时: ${summary.duration}ms\n` +
                `平均耗时: ${summary.avgTime.toFixed(2)}ms\n` +
                `吞吐量: ${summary.throughput.toFixed(2)} req/s\n\n` +
                `详细结果:\n${JSON.stringify(results, null, 2)}`,
                'success'
            );
        }

        // 开始监控
        async function startMonitoring() {
            if (!client) {
                showResult('monitorResult', '请先连接服务器', 'error');
                return;
            }

            if (monitoringInterval) {
                clearInterval(monitoringInterval);
            }

            await refreshMetrics();

            monitoringInterval = setInterval(async () => {
                await refreshMetrics();
            }, 5000);

            showResult('monitorResult', '监控已启动，每5秒刷新一次', 'success');
        }

        // 停止监控
        function stopMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
                showResult('monitorResult', '监控已停止', 'success');
            }
        }

        // 刷新指标
        async function refreshMetrics() {
            if (!client) return;

            try {
                const status = await client.callTool('getServerStatus', {});
                displayMetrics(status);
            } catch (error) {
                console.error('获取指标失败:', error);
            }
        }

        // 显示指标
        function displayMetrics(status) {
            const container = document.getElementById('metricsContainer');

            const metrics = [
                { label: '运行时间', value: `${Math.floor(status.uptime)}s` },
                { label: '内存使用', value: `${Math.round(status.memory.heapUsed / 1024 / 1024)}MB` },
                { label: '用户数量', value: status.userCount || 0 },
                { label: '文章数量', value: status.postCount || 0 }
            ];

            container.innerHTML = metrics.map(metric => `
                <div class="metric-card">
                    <div class="metric-value">${metric.value}</div>
                    <div class="metric-label">${metric.label}</div>
                </div>
            `).join('');
        }

        // 切换标签页
        function switchTab(tabName) {
            // 隐藏所有标签页内容
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // 移除所有标签的激活状态
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // 显示选中的标签页内容
            document.getElementById(`${tabName}-tab`).classList.add('active');

            // 激活选中的标签
            event.target.classList.add('active');
        }

        // 显示结果
        function showResult(elementId, message, type = '') {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.textContent = message;

            element.className = 'result';
            if (type) {
                element.classList.add(type);
            }
        }

        // 清空结果
        function clearResult() {
            document.getElementById('toolResult').style.display = 'none';
        }

        function clearBatchResult() {
            document.getElementById('batchResult').style.display = 'none';
        }

        // 页面加载完成后自动连接
        window.addEventListener('load', () => {
            // 可以选择自动连接
            // connectServer();
        });
    </script>
</body>
</html>