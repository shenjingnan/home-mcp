import { Callout, Tabs, Steps } from 'nextra/components'

# å¼€å‘æŒ‡å—

æ¬¢è¿å‚ä¸ Home-MCP çš„å¼€å‘ï¼æœ¬æŒ‡å—å°†å¸®åŠ©ä½ äº†è§£é¡¹ç›®æ¶æ„ã€å¼€å‘ç¯å¢ƒæ­å»ºä»¥åŠå¦‚ä½•è´¡çŒ®ä»£ç ã€‚

## ğŸ—ï¸ é¡¹ç›®æ¶æ„

Home-MCP é‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼Œæ¸…æ™°çš„æ¶æ„ä¾¿äºç†è§£å’Œæ‰©å±•ã€‚

```mermaid
graph TB
    subgraph "MCP Layer"
        A[MCP Server] --> B[Tool Registry]
        B --> C[Request Handler]
        C --> D[Response Builder]
    end

    subgraph "Service Layer"
        E[HassService] --> F[LightControlService]
        E --> G[DeviceStateManager]
        E --> H[ConfigurationManager]
    end

    subgraph "Transport Layer"
        I[HTTP Transport] --> J[Stdio Transport]
    end

    A --> E
    C --> I

    style A fill:#e1f5fe
    style E fill:#e8f5e8
    style I fill:#fff3e0
```

### æ ¸å¿ƒç»„ä»¶è¯´æ˜

| ç»„ä»¶ | èŒè´£ | å…³é”®æ–‡ä»¶ |
|------|------|----------|
| **MCP Server** | å¤„ç† MCP åè®®é€šä¿¡ | `src/server/` |
| **HassService** | Home Assistant API å°è£… | `src/services/hass.ts` |
| **LightControlService** | è¯­ä¹‰åŒ–ç¯å…‰æ§åˆ¶ | `src/services/light-control.ts` |
| **Tools Registry** | å·¥å…·æ³¨å†Œå’Œç®¡ç† | `src/tools/` |
| **Configuration** | é…ç½®ç®¡ç† | `src/config/` |

## ğŸ› ï¸ å¼€å‘ç¯å¢ƒæ­å»º

<Steps>
## å…‹éš†é¡¹ç›®
```bash
git clone https://github.com/shenjingnan/home-mcp.git
cd home-mcp
```

## å®‰è£…ä¾èµ–
```bash
# ä½¿ç”¨ pnpm å®‰è£…ä¾èµ–ï¼ˆæ¨èï¼‰
pnpm install

# æˆ–ä½¿ç”¨ npm
npm install
```

## é…ç½®å¼€å‘ç¯å¢ƒ
```bash
# å¤åˆ¶ç¯å¢ƒå˜é‡æ¨¡æ¿
cp .env.example .env

# ç¼–è¾‘ç¯å¢ƒå˜é‡
nano .env
```

## å¯åŠ¨å¼€å‘æœåŠ¡å™¨
```bash
# å¼€å‘æ¨¡å¼ï¼ˆæ”¯æŒçƒ­é‡è½½ï¼‰
pnpm dev

# æˆ–è€…è¿è¡Œæµ‹è¯•
pnpm test
```
</Steps>

### å¼€å‘ç¯å¢ƒé…ç½®

<Callout type="info" emoji="âš™ï¸">
  **æœ¬åœ° Home Assistant**: å»ºè®®åœ¨æœ¬åœ°æ­å»º Home Assistant å¼€å‘ç¯å¢ƒï¼Œå¯ä»¥æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªæ–°çš„ä»¤ç‰Œã€‚
</Callout>

```bash
# .env å¼€å‘ç¯å¢ƒé…ç½®ç¤ºä¾‹
HA_TOKEN="eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9..."
HA_BASE_URL="http://localhost:8123"
LOG_LEVEL="debug"
```

## ğŸ”§ ä»£ç è§„èŒƒ

é¡¹ç›®ä½¿ç”¨ [Biome](https://biomejs.dev/) è¿›è¡Œä»£ç æ ¼å¼åŒ–å’Œæ£€æŸ¥ï¼š

```bash
# ä»£ç æ£€æŸ¥
pnpm lint

# è‡ªåŠ¨ä¿®å¤
pnpm lint:fix

# ä»£ç æ ¼å¼åŒ–
pnpm format

# ç±»å‹æ£€æŸ¥
pnpm type-check
```

### TypeScript é…ç½®

é¡¹ç›®ä½¿ç”¨ä¸¥æ ¼çš„ TypeScript é…ç½®ï¼š

```json
{
  "compilerOptions": {
    "strict": true,
    "noImplicitAny": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true
  }
}
```

<Callout type="warning" emoji="âš ï¸">
  **ç±»å‹å®‰å…¨**: é¡¹ç›®ç¦æ­¢ä½¿ç”¨ `any` ç±»å‹ï¼Œè¯·ä½¿ç”¨æ˜ç¡®çš„ç±»å‹å®šä¹‰æˆ– `unknown`ã€‚
</Callout>

## ğŸ§ª æµ‹è¯•æŒ‡å—

### æµ‹è¯•æ¡†æ¶

é¡¹ç›®ä½¿ç”¨ [Vitest](https://vitest.dev/) ä½œä¸ºæµ‹è¯•æ¡†æ¶ï¼š

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pnpm test

# ç›‘å¬æ¨¡å¼
pnpm test:watch

# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
pnpm test:coverage

# æµ‹è¯•ç‰¹å®šæ–‡ä»¶
pnpm test src/services/hass.test.ts
```

### æµ‹è¯•ç»“æ„

```
src/
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ hass.ts
â”‚   â””â”€â”€ hass.test.ts
â”œâ”€â”€ tools/
â”‚   â”œâ”€â”€ light-control.ts
â”‚   â””â”€â”€ light-control.test.ts
â””â”€â”€ test/
    â”œâ”€â”€ fixtures/
    â”œâ”€â”€ mocks/
    â””â”€â”€ utils/
```

### æµ‹è¯•æœ€ä½³å®è·µ

```typescript
// æµ‹è¯•ç¤ºä¾‹
import { describe, it, expect, beforeEach } from 'vitest';
import { HassService } from '@/services/hass.js';
import { createMockTransport } from '@/test/utils/transport.js';

describe('HassService', () => {
  let hassService: HassService;
  let mockTransport: any;

  beforeEach(() => {
    mockTransport = createMockTransport();
    hassService = new HassService(mockTransport);
  });

  it('should get device states correctly', async () => {
    const mockResponse = [
      { entity_id: 'light.living_room', state: 'on' }
    ];

    mockTransport.request.mockResolvedValue(mockResponse);

    const result = await hassService.getStates();

    expect(result).toEqual(mockResponse);
    expect(mockTransport.request).toHaveBeenCalledWith({
      method: 'get_states'
    });
  });
});
```

## ğŸ“¦ æ„å»ºå’Œå‘å¸ƒ

### æ„å»ºæµç¨‹

```bash
# æ„å»ºç”Ÿäº§ç‰ˆæœ¬
pnpm build

# æ„å»ºè¾“å‡ºæ£€æŸ¥
ls -la dist/

# æœ¬åœ°æµ‹è¯•æ„å»ºç‰ˆæœ¬
node dist/index.js
```

### å‘å¸ƒæµç¨‹

<Steps>
## ç‰ˆæœ¬æ›´æ–°
```bash
# æ›´æ–°ç‰ˆæœ¬å·
npm version patch  # æˆ– minor, major

# ç”Ÿæˆ CHANGELOG
pnpm changelog
```

## æ„å»ºå’Œæµ‹è¯•
```bash
# ç¡®ä¿æ‰€æœ‰æµ‹è¯•é€šè¿‡
pnpm test

# æ„å»ºé¡¹ç›®
pnpm build

# è¿è¡Œé›†æˆæµ‹è¯•
pnpm test:integration
```

## å‘å¸ƒåˆ° npm
```bash
# ç™»å½• npmï¼ˆå¦‚æœæœªç™»å½•ï¼‰
npm login

# å‘å¸ƒåŒ…
npm publish

# å‘å¸ƒå¸¦æ ‡ç­¾çš„ç‰ˆæœ¬
npm publish --tag beta
```
</Steps>

## ğŸ¤ è´¡çŒ®æŒ‡å—

æˆ‘ä»¬æ¬¢è¿æ‰€æœ‰å½¢å¼çš„è´¡çŒ®ï¼åŒ…æ‹¬ä½†ä¸é™äºï¼š

- ğŸ› Bug ä¿®å¤
- âœ¨ æ–°åŠŸèƒ½å¼€å‘
- ğŸ“ æ–‡æ¡£æ”¹è¿›
- ğŸ§ª æµ‹è¯•ç”¨ä¾‹å¢åŠ 
- ğŸ”§ æ€§èƒ½ä¼˜åŒ–

### æäº¤æµç¨‹

<Steps>
## Fork é¡¹ç›®
1. è®¿é—® [GitHub](https://github.com/shenjingnan/home-mcp)
2. ç‚¹å‡» "Fork" æŒ‰é’®
3. å…‹éš†ä½ çš„ Fork

## åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
```bash
git checkout -b feature/amazing-feature
```

## å¼€å‘å’Œæµ‹è¯•
```bash
# ç¼–å†™ä»£ç 
pnpm dev

# è¿è¡Œæµ‹è¯•
pnpm test

# ä»£ç æ ¼å¼åŒ–
pnpm lint:fix
```

## æäº¤æ›´æ”¹
```bash
git add .
git commit -m "feat: æ·»åŠ  amazing feature"
```

## æ¨é€å’Œåˆ›å»º PR
```bash
git push origin feature/amazing-feature
```

ç„¶ååœ¨ GitHub ä¸Šåˆ›å»º Pull Requestã€‚
</Steps>

### æäº¤ä¿¡æ¯è§„èŒƒ

ä½¿ç”¨ [Conventional Commits](https://www.conventionalcommits.org/) è§„èŒƒï¼š

```
feat: æ·»åŠ æ–°åŠŸèƒ½
fix: ä¿®å¤ bug
docs: æ›´æ–°æ–‡æ¡£
style: ä»£ç æ ¼å¼è°ƒæ•´
refactor: ä»£ç é‡æ„
test: æ·»åŠ æµ‹è¯•
chore: æ„å»ºå·¥å…·æˆ–ä¾èµ–æ›´æ–°
```

## ğŸš€ è‡ªå®šä¹‰å·¥å…·å¼€å‘

### åˆ›å»ºæ–°å·¥å…·

<Steps>
## åˆ›å»ºå·¥å…·æ–‡ä»¶
åœ¨ `src/tools/` ç›®å½•ä¸‹åˆ›å»ºæ–°å·¥å…·ï¼š

```typescript
// src/tools/custom-device.ts
import { z } from 'zod';
import { HassService } from '@/services/hass.js';

const schema = z.object({
  deviceId: z.string(),
  action: z.enum(['turn_on', 'turn_off']),
  parameters: z.record(z.any()).optional()
});

export const customDeviceTool = {
  name: 'custom_device_control',
  description: 'è‡ªå®šä¹‰è®¾å¤‡æ§åˆ¶å·¥å…·',
  inputSchema: schema,

  async handler(args: z.infer<typeof schema>, hassService: HassService) {
    try {
      const result = await hassService.callService(
        'switch', // domain
        args.action, // service
        { entity_id: args.deviceId, ...args.parameters }
      );

      return {
        success: true,
        result
      };
    } catch (error) {
      return {
        success: false,
        error: error.message
      };
    }
  }
};
```

## æ³¨å†Œå·¥å…·
åœ¨ `src/index.ts` ä¸­æ³¨å†Œæ–°å·¥å…·ï¼š

```typescript
import { customDeviceTool } from '@/tools/custom-device.js';

// åœ¨å·¥å…·åˆ—è¡¨ä¸­æ·»åŠ 
const tools = [
  // ... ç°æœ‰å·¥å…·
  customDeviceTool
];
```

## æ·»åŠ æµ‹è¯•
```typescript
// src/tools/custom-device.test.ts
import { describe, it, expect } from 'vitest';
import { customDeviceTool } from '@/tools/custom-device.js';
import { createMockHassService } from '@/test/utils/hass.js';

describe('customDeviceTool', () => {
  it('should control device correctly', async () => {
    const mockHass = createMockHassService();

    const result = await customDeviceTool.handler(
      {
        deviceId: 'switch.test_device',
        action: 'turn_on'
      },
      mockHass
    );

    expect(result.success).toBe(true);
  });
});
```
</Steps>

### å·¥å…·å¼€å‘æœ€ä½³å®è·µ

1. **ç±»å‹å®‰å…¨**: ä½¿ç”¨ Zod è¿›è¡Œè¾“å…¥éªŒè¯
2. **é”™è¯¯å¤„ç†**: æä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯
3. **æµ‹è¯•è¦†ç›–**: ä¸ºæ¯ä¸ªå·¥å…·ç¼–å†™å®Œæ•´çš„æµ‹è¯•
4. **æ–‡æ¡£æ›´æ–°**: æ›´æ–°ç›¸å…³æ–‡æ¡£å’Œç¤ºä¾‹

## ğŸ” è°ƒè¯•å’Œæ•…éšœæ’é™¤

### å¼€å‘è°ƒè¯•

```bash
# å¯ç”¨è°ƒè¯•æ—¥å¿—
LOG_LEVEL=debug pnpm dev

# ä½¿ç”¨ VS Code è°ƒè¯•
# åœ¨ .vscode/launch.json ä¸­æ·»åŠ é…ç½®
```

VS Code è°ƒè¯•é…ç½®ç¤ºä¾‹ï¼š

```json
{
  "version": "0.2.0",
  "configurations": [
    {
      "name": "Debug Home-MCP",
      "type": "node",
      "request": "launch",
      "program": "${workspaceFolder}/src/index.ts",
      "env": {
        "LOG_LEVEL": "debug"
      },
      "runtimeArgs": ["-r", "ts-node/register"],
      "skipFiles": ["<node_internals>/**"]
    }
  ]
}
```

### æ€§èƒ½åˆ†æ

```bash
# æ€§èƒ½åˆ†æ
pnpm build --analyze

# å†…å­˜ä½¿ç”¨åˆ†æ
node --inspect dist/index.js
```

<Callout type="success" emoji="ğŸ‰">
  **å¼€å§‹è´¡çŒ®**: ç°åœ¨ä½ å·²ç»äº†è§£äº† Home-MCP çš„å¼€å‘æµç¨‹ï¼Œæ¬¢è¿ä¸ºé¡¹ç›®åšå‡ºè´¡çŒ®ï¼
</Callout>
