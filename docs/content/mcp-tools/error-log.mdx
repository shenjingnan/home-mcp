# 错误日志

## 工具介绍

错误日志工具提供对 Home Assistant 当前会话期间记录的所有错误日志的访问，帮助诊断系统问题、集成错误和设备故障。

## 使用示例

### 获取错误日志
```typescript
// 获取当前会话的所有错误日志
const errorLog = await getErrorLog();
console.log("错误日志内容:");
console.log(errorLog);
```

### 错误分析
```typescript
// 分析错误类型和频率
const errorLog = await getErrorLog();
const errorLines = errorLog.split('\n').filter(line => line.trim());

// 统计不同类型的错误
const errorTypes = {};
errorLines.forEach(line => {
  const type = extractErrorType(line);
  errorTypes[type] = (errorTypes[type] || 0) + 1;
});

console.log("错误类型统计:", errorTypes);
```

## 返回值格式

### 纯文本格式
错误日志以纯文本字符串形式返回，包含以下信息：

```
2025-01-15 14:30:25 ERROR (MainThread) [homeassistant.core] Error doing something: Connection failed
2025-01-15 14:32:10 WARNING (MainThread) [homeassistant.components.light] Light device not responding
2025-01-15 14:35:45 ERROR (SyncWorker_1) [homeassistant.components.zha] Zigbee device disconnected
```

### 典型错误日志结构

#### 系统错误
```
2025-01-15 10:30:25 ERROR (MainThread) [homeassistant.core] Error processing service call: Invalid parameters
```

#### 集成错误
```
2025-01-15 11:15:10 ERROR (MainThread) [homeassistant.components.mqtt] Failed to connect to MQTT server
```

#### 设备错误
```
2025-01-15 12:20:45 WARNING (MainThread) [homeassistant.components.light] Living room light not responding
```

#### 自动化错误
```
2025-01-15 13:45:30 ERROR (MainThread) [homeassistant.components.automation] Evening lights automation failed: Invalid template
```

## 日志级别

### ERROR
- 严重错误，影响系统功能
- 通常需要立即处理
- 包含详细的错误信息和堆栈跟踪

### WARNING
- 警告信息，可能不影响功能
- 建议关注和检查
- 通常与设备状态或配置相关

### INFO
- 一般信息，正常操作日志
- 不需要特别处理

## 常见错误类型

### 连接错误
```
ERROR (MainThread) [homeassistant.components.rest] Failed to reach API: Connection timeout
```

### 配置错误
```
ERROR (MainThread) [homeassistant.config] Invalid configuration for component light
```

### 权限错误
```
ERROR (MainThread) [homeassistant.auth] User 'test' does not have permission to perform this action
```

### 设备错误
```
ERROR (MainThread) [homeassistant.components.zha] Device '0x00158d0001234567' is not responding
```

### 集成错误
```
ERROR (MainThread) [homeassistant.components.template] Error rendering template: undefined variable 'sensor.temperature'
```

## 错误分析工具

### 提取时间戳
```typescript
function extractTimestamps(logContent) {
  const timestampRegex = /\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}/g;
  return logContent.match(timestampRegex) || [];
}
```

### 统计错误级别
```typescript
function countErrorLevels(logContent) {
  const levels = { ERROR: 0, WARNING: 0, INFO: 0 };
  const lines = logContent.split('\n');

  lines.forEach(line => {
    if (line.includes('ERROR')) levels.ERROR++;
    else if (line.includes('WARNING')) levels.WARNING++;
    else if (line.includes('INFO')) levels.INFO++;
  });

  return levels;
}
```

### 按组件分组
```typescript
function groupByComponent(logContent) {
  const componentRegex = /\[([^\]]+)\]/g;
  const groups = {};
  const lines = logContent.split('\n');

  lines.forEach(line => {
    const match = componentRegex.exec(line);
    if (match) {
      const component = match[1];
      groups[component] = (groups[component] || 0) + 1;
    }
  });

  return groups;
}
```

## 故障排查流程

### 1. 获取错误日志
```typescript
const errorLog = await getErrorLog();
if (!errorLog.trim()) {
  console.log("当前会话没有错误日志");
  return;
}
```

### 2. 分析错误严重性
```typescript
const errorCount = (errorLog.match(/ERROR/g) || []).length;
const warningCount = (errorLog.match(/WARNING/g) || []).length;

console.log(`发现 ${errorCount} 个错误，${warningCount} 个警告`);

if (errorCount > 0) {
  console.log("需要立即处理的严重错误");
}
```

### 3. 定位问题组件
```typescript
const componentErrors = groupByComponent(errorLog);
const problematicComponents = Object.entries(componentErrors)
  .filter(([component, count]) => count > 5)
  .sort(([,a], [,b]) => b - a);

console.log("问题最严重的组件:", problematicComponents);
```

### 4. 生成报告
```typescript
function generateErrorReport(logContent) {
  const timestamp = new Date().toISOString();
  const errorLevels = countErrorLevels(logContent);
  const components = groupByComponent(logContent);

  return {
    timestamp,
    summary: {
      totalErrors: errorLevels.ERROR,
      totalWarnings: errorLevels.WARNING,
      problematicComponents: Object.keys(components).length
    },
    details: {
      errorLevels,
      componentBreakdown: components
    }
  };
}
```

## 最佳实践

### 定期监控
```typescript
// 设置定期错误检查
async function monitorErrors() {
  const errorLog = await getErrorLog();
  const errorCount = (errorLog.match(/ERROR/g) || []).length;

  if (errorCount > 10) {
    console.warn("检测到大量错误，建议检查系统状态");
    // 发送通知或执行其他处理
  }
}

// 每30分钟检查一次
setInterval(monitorErrors, 30 * 60 * 1000);
```

### 错误过滤
```typescript
function filterCriticalErrors(logContent) {
  const lines = logContent.split('\n');
  const criticalKeywords = [
    'core', 'config', 'auth', 'database'
  ];

  return lines.filter(line => {
    return line.includes('ERROR') &&
           criticalKeywords.some(keyword => line.includes(keyword));
  }).join('\n');
}
```

## 注意事项

- 错误日志仅包含当前 Home Assistant 会话的数据
- 重启 Home Assistant 会清空之前的错误日志
- 日志内容取决于 Home Assistant 的日志配置
- 某些内部错误可能不会出现在用户可访问的日志中

## 错误处理

| 错误类型 | 可能原因 | 解决方案 |
|----------|----------|----------|
| 无权限访问 | 用户没有查看系统日志的权限 | 检查 Home Assistant 用户权限配置 |
| 日志服务不可用 | 日志系统未正确配置 | 检查 `logger` 集成配置 |
| 返回空内容 | 当前会话无错误或系统刚启动 | 这是正常情况，无需处理 |

## 相关工具

- **History**: 查看历史状态变化
- **Logbook**: 查看用户操作和设备事件记录
- **Config**: 验证系统配置是否正确