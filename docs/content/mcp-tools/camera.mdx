# 摄像头

## 工具介绍

摄像头工具提供对 Home Assistant 中摄像头实体的访问功能，允许获取实时图像数据用于监控、分析和处理。

## 参数定义

| 参数 | 类型 | 必需 | 说明 |
|------|------|------|------|
| `camera_entity_id` | string | 是 | 要获取图像的摄像头实体ID |

## 使用示例

### 获取实时图像
```typescript
// 获取客厅摄像头的实时图像
const image = await getCameraProxy({
  camera_entity_id: "camera.living_room"
});

// 图像数据是 base64 编码的字符串
console.log("获取到图像数据，长度:", image.length);
```

### 多摄像头监控
```typescript
// 监控多个摄像头
const cameras = [
  "camera.front_door",
  "camera.backyard",
  "camera.garage"
];

const images = await Promise.all(
  cameras.map(cameraId =>
    getCameraProxy({ camera_entity_id: cameraId })
  )
);

console.log(`成功获取 ${images.length} 个摄像头的图像`);
```

### 图像处理
```typescript
// 获取图像并保存或处理
const cameraId = "camera.security_main";
const imageData = await getCameraProxy({
  camera_entity_id: cameraId
});

// 图像数据可以直接用于进一步处理
const base64Data = `data:image/jpeg;base64,${imageData}`;

// 保存到文件或发送到其他服务
await saveImageToFile(base64Data, `${cameraId}_${Date.now()}.jpg`);
```

## 返回值格式

### Base64 图像数据
```typescript
// 返回的图像数据是 base64 编码的字符串
const imageData = "iVBORw0KGgoAAAANSUhEUgAA...";
// 这是一个 JPEG 或 PNG 图像的 base64 编码
```

### 完整图像 URL
```typescript
// 如果需要构建完整的图像 URL
const base64Data = `data:image/jpeg;base64,${imageData}`;
```

## 摄像头类型

### IP 摄像头
```typescript
// 典型的 IP 摄像头实体ID
const ipCamera = "camera.front_door_ip";
const image = await getCameraProxy({
  camera_entity_id: ipCamera
});
```

### USB 摄像头
```typescript
// USB 连接的摄像头
const usbCamera = "camera.usb_webcam";
const image = await getCameraProxy({
  camera_entity_id: usbCamera
});
```

### 网络摄像头
```typescript
// 网络摄像头
const netCamera = "camera.network_cam";
const image = await getCameraProxy({
  camera_entity_id: netCamera
});
```

## 图像数据使用

### 显示图像
```typescript
// 在网页中显示图像
function displayCameraImage(entityId) {
  getCameraProxy({ camera_entity_id: entityId })
    .then(imageData => {
      const img = document.createElement('img');
      img.src = `data:image/jpeg;base64,${imageData}`;
      document.body.appendChild(img);
    });
}
```

### 图像分析
```typescript
// 分析图像亮度（简化示例）
async function analyzeImageBrightness(cameraId) {
  const imageData = await getCameraProxy({
    camera_entity_id: cameraId
  });

  // 将 base64 转换为二进制数据进行图像处理
  const binaryData = atob(imageData);
  // ... 图像分析逻辑

  return brightness; // 返回亮度值
}
```

### 图像存储
```typescript
// 保存图像到本地存储
async function saveCameraSnapshot(cameraId, filename) {
  const imageData = await getCameraProxy({
    camera_entity_id: cameraId
  });

  // 构建完整的数据 URL
  const dataUrl = `data:image/jpeg;base64,${imageData}`;

  // 保存到文件系统或云存储
  await saveToCloudStorage(filename, dataUrl);
}
```

## 高级用法

### 定时抓拍
```typescript
// 定时获取摄像头快照
async function scheduleCameraSnapshots(cameraId, interval = 60000) {
  const captureSnapshot = async () => {
    try {
      const imageData = await getCameraProxy({
        camera_entity_id: cameraId
      });

      const timestamp = new Date().toISOString();
      const filename = `${cameraId}_${timestamp}.jpg`;

      await saveImage(filename, imageData);
      console.log(`保存快照: ${filename}`);
    } catch (error) {
      console.error(`获取 ${cameraId} 快照失败:`, error);
    }
  };

  // 立即拍摄一次
  await captureSnapshot();

  // 设置定时拍摄
  setInterval(captureSnapshot, interval);
}

// 每分钟拍摄一次
scheduleCameraSnapshots("camera.security_main", 60000);
```

### 移动检测
```typescript
// 简单的移动检测（需要图像处理库）
async function detectMotion(cameraId) {
  const imageData = await getCameraProxy({
    camera_entity_id: cameraId
  });

  // 转换图像数据
  const currentFrame = await decodeImage(imageData);

  // 与前一帧比较
  if (previousFrame) {
    const motionDetected = compareFrames(currentFrame, previousFrame);
    if (motionDetected) {
      console.log(`检测到移动: ${cameraId}`);
      // 触发报警或记录
      await triggerMotionAlert(cameraId, imageData);
    }
  }

  previousFrame = currentFrame;
}
```

### 摄像头状态检查
```typescript
// 检查摄像头是否在线
async function checkCameraStatus(cameraId) {
  try {
    const imageData = await getCameraProxy({
      camera_entity_id: cameraId
    });

    // 检查返回的数据是否有效
    if (imageData && imageData.length > 0) {
      return { status: "online", lastCheck: new Date() };
    }
  } catch (error) {
    return {
      status: "offline",
      error: error.message,
      lastCheck: new Date()
    };
  }
}

// 检查所有摄像头状态
const cameras = ["camera.front_door", "camera.backyard"];
const statusChecks = await Promise.all(
  cameras.map(async cameraId => ({
    cameraId,
    ...(await checkCameraStatus(cameraId))
  }))
);

console.table(statusChecks);
```

## 性能考虑

### 图像大小
- 摄像头分辨率影响返回数据大小
- 高分辨率图像可能需要更长时间传输
- 考虑根据需求调整摄像头分辨率

### 网络带宽
- 频繁获取图像可能消耗大量带宽
- 建议合理安排抓拍频率
- 考虑使用图像压缩

### 存储空间
- 图像数据需要存储空间
- 定期清理旧的图像文件
- 考虑使用云存储服务

## 错误处理

### 常见错误
```typescript
try {
  const imageData = await getCameraProxy({
    camera_entity_id: "camera.nonexistent"
  });
} catch (error) {
  if (error.message.includes("not found")) {
    console.error("摄像头实体不存在");
  } else if (error.message.includes("unavailable")) {
    console.error("摄像头当前不可用");
  } else {
    console.error("获取图像失败:", error.message);
  }
}
```

### 错误类型
| 错误类型 | 可能原因 | 解决方案 |
|----------|----------|----------|
| 实体不存在 | 摄像头实体ID错误 | 检查实体ID拼写 |
| 设备离线 | 摄像头断开连接 | 检查摄像头网络连接 |
| 权限不足 | 用户没有访问权限 | 检查 Home Assistant 权限配置 |
| 图像损坏 | 摄像头故障或配置错误 | 检查摄像头配置和状态 |
| 超时 | 网络延迟或摄像头响应慢 | 增加超时时间或检查网络 |

## 最佳实践

### 错误重试
```typescript
async function getCameraImageWithRetry(cameraId, maxRetries = 3) {
  for (let i = 0; i < maxRetries; i++) {
    try {
      return await getCameraProxy({
        camera_entity_id: cameraId
      });
    } catch (error) {
      if (i === maxRetries - 1) throw error;

      console.warn(`第 ${i + 1} 次尝试失败，等待后重试...`);
      await new Promise(resolve => setTimeout(resolve, 2000));
    }
  }
}
```

### 图像缓存
```typescript
class CameraImageCache {
  constructor(ttl = 30000) {
    this.cache = new Map();
    this.ttl = ttl;
  }

  async getImage(cameraId) {
    const cached = this.cache.get(cameraId);

    if (cached && Date.now() - cached.timestamp < this.ttl) {
      return cached.data;
    }

    const imageData = await getCameraProxy({
      camera_entity_id: cameraId
    });

    this.cache.set(cameraId, {
      data: imageData,
      timestamp: Date.now()
    });

    return imageData;
  }
}

const cameraCache = new CameraImageCache();
```

## 注意事项

- 确保摄像头在 Home Assistant 中正确配置
- 图像数据是实时的，不支持历史图像查询
- 考虑隐私和法律问题，仅在授权区域使用
- 某些摄像头可能需要额外的配置或认证

## 相关工具

- **States**: 查看摄像头的当前状态和属性
- **Services**: 调用摄像头相关服务（如录制）
- **History**: 查看摄像头状态的历史记录