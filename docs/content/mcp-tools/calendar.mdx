# 日历

## 工具介绍

日历工具提供对 Home Assistant 中日历实体的访问，允许查询日历事件、管理日程安排和集成个人日历数据。

## 参数定义

| 参数 | 类型 | 必需 | 说明 |
|------|------|------|------|
| `calendar_entity_id` | string (可选) | 否 | 指定查询的日历实体ID |
| `start_time` | string (可选) | 否 | 查询开始时间，ISO 8601 格式 |
| `end_time` | string (可选) | 否 | 查询结束时间，ISO 8601 格式 |

## 使用示例

### 获取所有日历
```typescript
// 获取系统中所有可用的日历
const calendars = await getCalendars();
console.log("可用日历:", calendars);

// 示例输出:
// [
//   { entity_id: "calendar.personal", name: "Personal Calendar" },
//   { entity_id: "calendar.holidays", name: "National Holidays" },
//   { entity_id: "calendar.work", name: "Work Schedule" }
// ]
```

### 查询特定时间段的事件
```typescript
// 查询今日的日历事件
const today = new Date();
const tomorrow = new Date(today);
tomorrow.setDate(tomorrow.getDate() + 1);

const events = await getCalendars({
  start_time: today.toISOString(),
  end_time: tomorrow.toISOString()
});
```

### 查询特定日历
```typescript
// 查询个人日历的事件
const personalEvents = await getCalendars({
  calendar_entity_id: "calendar.personal"
});
```

### 获取即将到来的事件
```typescript
// 查询未来一周的事件
const now = new Date();
const nextWeek = new Date(now);
nextWeek.setDate(nextWeek.getDate() + 7);

const upcomingEvents = await getCalendars({
  start_time: now.toISOString(),
  end_time: nextWeek.toISOString()
});
```

## 返回值格式

### 日历列表响应
```json
[
  {
    "entity_id": "calendar.personal",
    "name": "Personal Calendar",
    "friendly_name": "Personal Calendar"
  },
  {
    "entity_id": "calendar.holidays",
    "name": "National Holidays",
    "friendly_name": "National Holidays"
  }
]
```

### 日历事件响应
```json
[
  {
    "entity_id": "calendar.personal",
    "summary": "团队会议",
    "start": "2025-01-15T10:00:00+00:00",
    "end": "2025-01-15T11:00:00+00:00",
    "location": "会议室A",
    "description": "讨论项目进展",
    "all_day": false
  },
  {
    "entity_id": "calendar.holidays",
    "summary": "春节",
    "start": "2025-01-29T00:00:00+00:00",
    "end": "2025-01-30T00:00:00+00:00",
    "all_day": true
  }
]
```

## 常见日历类型

### 个人日历
```typescript
const personalCal = await getCalendars({
  calendar_entity_id: "calendar.personal"
});
```

### 工作日历
```typescript
const workCal = await getCalendars({
  calendar_entity_id: "calendar.work"
});
```

### 节假日日历
```typescript
const holidays = await getCalendars({
  calendar_entity_id: "calendar.holidays"
});
```

### 共享日历
```typescript
const sharedCal = await getCalendars({
  calendar_entity_id: "calendar.family"
});
```

## 高级用法

### 事件筛选
```typescript
// 筛选今日重要事件
async function getTodayImportantEvents() {
  const today = new Date();
  const tomorrow = new Date(today);
  tomorrow.setDate(tomorrow.getDate() + 1);

  const events = await getCalendars({
    start_time: today.toISOString(),
    end_time: tomorrow.toISOString()
  });

  // 筛选包含"重要"关键词的事件
  return events.filter(event =>
    event.summary.includes("重要") ||
    event.description?.includes("紧急") ||
    event.location?.includes("总部")
  );
}
```

### 日程冲突检测
```typescript
// 检测日程冲突
async function detectScheduleConflicts(calendarId) {
  const events = await getCalendars({
    calendar_entity_id: calendarId
  });

  const conflicts = [];
  for (let i = 0; i < events.length; i++) {
    for (let j = i + 1; j < events.length; j++) {
      const event1 = events[i];
      const event2 = events[j];

      if (eventsOverlap(event1, event2)) {
        conflicts.push({
          event1: event1.summary,
          event2: event2.summary,
          time: `${event1.start} - ${event1.end}`
        });
      }
    }
  }

  return conflicts;
}

function eventsOverlap(event1, event2) {
  const start1 = new Date(event1.start);
  const end1 = new Date(event1.end);
  const start2 = new Date(event2.start);
  const end2 = new Date(event2.end);

  return start1 < end2 && start2 < end1;
}
```

### 忙碌时间统计
```typescript
// 统计日程忙碌时间
async function calculateBusyTime(calendarId, startDate, endDate) {
  const events = await getCalendars({
    calendar_entity_id: calendarId,
    start_time: startDate.toISOString(),
    end_time: endDate.toISOString()
  });

  let totalBusyMinutes = 0;
  const dailyStats = {};

  events.forEach(event => {
    if (event.all_day) return; // 跳过全天事件

    const start = new Date(event.start);
    const end = new Date(event.end);
    const duration = (end - start) / (1000 * 60); // 转换为分钟

    totalBusyMinutes += duration;

    const dateKey = start.toISOString().split('T')[0];
    dailyStats[dateKey] = (dailyStats[dateKey] || 0) + duration;
  });

  return {
    totalBusyHours: totalBusyMinutes / 60,
    dailyStats,
    eventCount: events.length
  };
}
```

### 会议提醒
```typescript
// 设置会议提醒
async function checkUpcomingMeetings() {
  const now = new Date();
  const oneHourLater = new Date(now.getTime() + 60 * 60 * 1000);

  const events = await getCalendars({
    start_time: now.toISOString(),
    end_time: oneHourLater.toISOString()
  });

  events.forEach(event => {
    const eventTime = new Date(event.start);
    const timeUntilEvent = eventTime - now;
    const minutesUntil = timeUntilEvent / (1000 * 60);

    if (minutesUntil <= 30 && minutesUntil > 25) {
      console.log(`提醒: ${event.summary} 将在 ${Math.round(minutesUntil)} 分钟后开始`);
      console.log(`地点: ${event.location || '未指定'}`);

      // 发送通知
      sendNotification({
        title: "会议提醒",
        message: `${event.summary} - ${event.location || '未指定'}`,
        time: minutesUntil
      });
    }
  });
}
```

### 日历同步
```typescript
// 同步多个日历数据
async function syncCalendars() {
  const calendarIds = [
    "calendar.personal",
    "calendar.work",
    "calendar.family"
  ];

  const allEvents = [];

  for (const calendarId of calendarIds) {
    try {
      const events = await getCalendars({
        calendar_entity_id: calendarId,
        start_time: new Date().toISOString()
      });

      allEvents.push(...events.map(event => ({
        ...event,
        source: calendarId
      })));
    } catch (error) {
      console.error(`同步 ${calendarId} 失败:`, error);
    }
  }

  // 按时间排序
  allEvents.sort((a, b) => new Date(a.start) - new Date(b.start));

  return allEvents;
}
```

## 时间格式说明

### ISO 8601 格式
```
2025-01-15T10:30:00+00:00
```
- **日期**: YYYY-MM-DD
- **时间**: hh:mm:ss
- **时区**: +00:00 (UTC)

### 时间处理示例
```typescript
// 时间转换和处理
function formatEventTime(event) {
  const start = new Date(event.start);
  const end = new Date(event.end);

  const options = {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  };

  return {
    start: start.toLocaleString('zh-CN', options),
    end: end.toLocaleString('zh-CN', options),
    duration: calculateDuration(start, end)
  };
}
```

## 配置要求

### Home Assistant 配置
```yaml
# configuration.yaml
calendar:
  - platform: caldav
    username: !secret email_username
    password: !secret email_password
    url: https://caldav.example.com/

  - platform: google
    client_id: !secret google_client_id
    client_secret: !secret google_client_secret
```

### 权限设置
- 确保 Home Assistant 有访问日历的权限
- 配置适当的 OAuth 凭据
- 设置正确的日历 URL 和认证信息

## 注意事项

- 日历数据需要网络连接才能获取
- 不同日历平台可能有不同的限制
- 考虑时区差异和夏令时影响
- 大量事件查询可能影响性能

## 错误处理

### 常见错误
| 错误类型 | 可能原因 | 解决方案 |
|----------|----------|----------|
| 认证失败 | 日历服务认证信息错误 | 检查用户名、密码或OAuth配置 |
| 网络超时 | 日历服务无响应 | 检查网络连接和服务状态 |
| 权限不足 | 用户没有访问权限 | 检查日历共享权限设置 |
| 格式错误 | 时间格式不正确 | 使用正确的ISO 8601格式 |

### 错误处理示例
```typescript
async function safeGetCalendars(params) {
  try {
    return await getCalendars(params);
  } catch (error) {
    if (error.message.includes('authentication')) {
      console.error('日历认证失败，请检查凭据');
    } else if (error.message.includes('network')) {
      console.error('网络错误，请检查连接');
    } else {
      console.error('获取日历数据失败:', error.message);
    }
    return [];
  }
}
```

## 相关工具

- **Services**: 创建或修改日历事件
- **Automation**: 基于日历事件触发自动化
- **States**: 查看日历实体的当前状态